<!DOCTYPE HTML>
<html lang="en" class="ayu" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Custom Gas Token - OP Stack Specification</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('ayu')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../root.html"><strong aria-hidden="true">1.</strong> Root</a></li><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../protocol/overview.html"><strong aria-hidden="true">3.</strong> OP Stack Protocol</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/bridges.html"><strong aria-hidden="true">3.1.</strong> Bridges</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/messengers.html"><strong aria-hidden="true">3.1.1.</strong> Messengers</a></li><li class="chapter-item expanded "><a href="../protocol/deposits.html"><strong aria-hidden="true">3.1.2.</strong> Deposits</a></li><li class="chapter-item expanded "><a href="../protocol/withdrawals.html"><strong aria-hidden="true">3.1.3.</strong> Withdrawals</a></li><li class="chapter-item expanded "><a href="../protocol/guaranteed-gas-market.html"><strong aria-hidden="true">3.1.4.</strong> Guaranteed Gas Market</a></li><li class="chapter-item expanded "><a href="../protocol/proposals.html"><strong aria-hidden="true">3.1.5.</strong> Proposals</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.2.</strong> Clients</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/exec-engine.html"><strong aria-hidden="true">3.2.1.</strong> Execution Engine</a></li><li class="chapter-item expanded "><a href="../protocol/rollup-node.html"><strong aria-hidden="true">3.2.2.</strong> Rollup Node</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/rollup-node-p2p.html"><strong aria-hidden="true">3.2.2.1.</strong> Rollup Node P2P</a></li><li class="chapter-item expanded "><a href="../protocol/derivation.html"><strong aria-hidden="true">3.2.2.2.</strong> Derivation</a></li><li class="chapter-item expanded "><a href="../protocol/span-batches.html"><strong aria-hidden="true">3.2.2.3.</strong> Span Batches</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/batcher.html"><strong aria-hidden="true">3.2.3.</strong> Batch Submitter</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/predeploys.html"><strong aria-hidden="true">3.3.</strong> Predeploys</a></li><li class="chapter-item expanded "><a href="../protocol/preinstalls.html"><strong aria-hidden="true">3.4.</strong> Preinstalls</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.5.</strong> Superchain</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../protocol/superchain-configuration.html"><strong aria-hidden="true">3.5.1.</strong> Superchain Configuration</a></li><li class="chapter-item expanded "><a href="../protocol/superchain-upgrades.html"><strong aria-hidden="true">3.5.2.</strong> Superchain Upgrades</a></li></ol></li><li class="chapter-item expanded "><a href="../protocol/system_config.html"><strong aria-hidden="true">3.6.</strong> System Config</a></li><li class="chapter-item expanded "><a href="../protocol/configurability.html"><strong aria-hidden="true">3.7.</strong> Configurability</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Experimental</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/index.html"><strong aria-hidden="true">4.1.</strong> Fault Proof</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/cannon-fault-proof-vm.html"><strong aria-hidden="true">4.1.1.</strong> Cannon Fault Proof VM</a></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/index.html"><strong aria-hidden="true">4.1.2.</strong> Stage One Decentralization</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/dispute-game-interface.html"><strong aria-hidden="true">4.1.2.1.</strong> Dispute Game Interface</a></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/fault-dispute-game.html"><strong aria-hidden="true">4.1.2.2.</strong> Fault Dispute Game</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/honest-challenger-fdg.html"><strong aria-hidden="true">4.1.2.2.1.</strong> Honest Challenger</a></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/bond-incentives.html"><strong aria-hidden="true">4.1.2.2.2.</strong> Bond Incentives</a></li></ol></li><li class="chapter-item expanded "><a href="../experimental/fault-proof/stage-one/bridge-integration.html"><strong aria-hidden="true">4.1.2.3.</strong> Bridge Integration</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../experimental/custom-gas-token.html" class="active"><strong aria-hidden="true">4.2.</strong> Custom Gas Token</a></li><li class="chapter-item expanded "><a href="../experimental/plasma.html"><strong aria-hidden="true">4.3.</strong> Plasma</a></li><li class="chapter-item expanded "><a href="../interop/overview.html"><strong aria-hidden="true">4.4.</strong> Interoperability</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../interop/dependency_set.html"><strong aria-hidden="true">4.4.1.</strong> Dependency Set</a></li><li class="chapter-item expanded "><a href="../interop/messaging.html"><strong aria-hidden="true">4.4.2.</strong> Messaging</a></li><li class="chapter-item expanded "><a href="../interop/predeploys.html"><strong aria-hidden="true">4.4.3.</strong> Predeploys</a></li><li class="chapter-item expanded "><a href="../interop/execution.html"><strong aria-hidden="true">4.4.4.</strong> Execution</a></li><li class="chapter-item expanded "><a href="../interop/sequencer.html"><strong aria-hidden="true">4.4.5.</strong> Sequencer</a></li><li class="chapter-item expanded "><a href="../interop/verifier.html"><strong aria-hidden="true">4.4.6.</strong> Verifier</a></li><li class="chapter-item expanded "><a href="../interop/rollup_node_p2p.html"><strong aria-hidden="true">4.4.7.</strong> Rollup Node P2P</a></li><li class="chapter-item expanded "><a href="../interop/fault_proof.html"><strong aria-hidden="true">4.4.8.</strong> Fault Proof</a></li><li class="chapter-item expanded "><a href="../interop/upgrade.html"><strong aria-hidden="true">4.4.9.</strong> Upgrade</a></li></ol></li><li class="chapter-item expanded "><a href="../experimental/security-council-safe.html"><strong aria-hidden="true">4.5.</strong> Security Council Safe</a></li></ol></li><li class="chapter-item expanded "><a href="../glossary.html"><strong aria-hidden="true">5.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OP Stack Specification</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/ethereum-optimism/specs/edit/main/specs/experimental/custom-gas-token.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
<h1 id="custom-gas-token"><a class="header" href="#custom-gas-token">Custom Gas Token</a></h1>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#constants">Constants</a></li>
<li><a href="#properties-of-a-gas-paying-token">Properties of a Gas Paying Token</a>
<ul>
<li><a href="#automated-validation">Automated Validation</a></li>
</ul>
</li>
<li><a href="#configuring-the-gas-paying-token">Configuring the Gas Paying Token</a></li>
<li><a href="#contract-modifications">Contract Modifications</a>
<ul>
<li><a href="#igastoken-interface">IGasToken Interface</a></li>
<li><a href="#gas-token-aware">Gas Token Aware</a></li>
<li><a href="#optimismportal">OptimismPortal</a>
<ul>
<li><a href="#depositerc20transaction"><code>depositERC20Transaction</code></a>
<ul>
<li><a href="#function-arguments">Function Arguments</a></li>
</ul>
</li>
<li><a href="#deposittransaction"><code>depositTransaction</code></a></li>
<li><a href="#setgaspayingtoken"><code>setGasPayingToken</code></a></li>
</ul>
</li>
<li><a href="#standardbridge">StandardBridge</a></li>
<li><a href="#crossdomainmessenger">CrossDomainMessenger</a></li>
<li><a href="#systemconfig">SystemConfig</a>
<ul>
<li><a href="#initialize">initialize</a></li>
</ul>
</li>
<li><a href="#l1block">L1Block</a></li>
<li><a href="#weth9">WETH9</a></li>
</ul>
</li>
<li><a href="#user-flow">User Flow</a>
<ul>
<li><a href="#when-eth-is-the-native-asset">When ETH is the Native Asset</a></li>
<li><a href="#when-an-erc20-token-is-the-native-asset">When an ERC20 Token is the Native Asset</a></li>
<li><a href="#differences">Differences</a></li>
</ul>
</li>
<li><a href="#upgrade">Upgrade</a>
<ul>
<li><a href="#l1block-deployment">L1Block Deployment</a></li>
<li><a href="#l2crossdomainmessenger-deployment">L2CrossDomainMessenger Deployment</a></li>
<li><a href="#l2standardbridge-deployment">L2StandardBridge Deployment</a></li>
<li><a href="#l1block-proxy-update">L1Block Proxy Update</a></li>
<li><a href="#l2crossdomainmessenger-proxy-update">L2CrossDomainMessenger Proxy Update</a></li>
<li><a href="#l2standardbridge-proxy-update">L2StandardBridge Proxy Update</a></li>
</ul>
</li>
<li><a href="#selection-of-ether_token_address">Selection of <code>ETHER_TOKEN_ADDRESS</code></a></li>
<li><a href="#standard-config">Standard Config</a></li>
<li><a href="#fees">Fees</a></li>
<li><a href="#security-considerations">Security Considerations</a>
<ul>
<li><a href="#optimismportal-token-allowance">OptimismPortal Token Allowance</a></li>
<li><a href="#interoperability-support">Interoperability Support</a></li>
<li><a href="#wrapped-ether">Wrapped Ether</a></li>
</ul>
</li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>Custom gas token is also known as "custom L2 native asset". It allows for an L1-native ERC20 token to collateralize
and act as the gas token on L2. The native asset is used to buy gas which is used to pay for resources on the network
and is represented by EVM opcodes such as <code>CALLVALUE</code> (<code>msg.value</code>).</p>
<p>Both the L1 and L2 smart contract systems MUST be able to introspect on the address of the gas paying token to
ensure the security of the system. The source of truth for the configuration of the address of the token is
in the L1 <code>SystemConfig</code> smart contract.</p>
<p>The terms "custom gas token", "gas paying token", "native asset" and "gas paying asset" can all be used interchangebly.
Note, Ether is not a <strong>custom</strong> gas token, but may be used to pay gas. More on this in
<a href="#-Configuring-the-Gas-Paying-Token">## Configuring the Gas Paying Token</a>.</p>
<h2 id="constants"><a class="header" href="#constants">Constants</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Constant</th><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td><code>ETHER_TOKEN_ADDRESS</code></td><td><code>address(0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE)</code></td><td>Represents ether for gas paying asset</td></tr>
<tr><td><code>DEPOSITOR_ACCOUNT</code></td><td><code>address(0xDeaDDEaDDeAdDeAdDEAdDEaddeAddEAdDEAd0001)</code></td><td>Account with auth permissions on <code>L1Block</code> contract</td></tr>
<tr><td><code>GAS_PAYING_TOKEN_SLOT</code></td><td><code>bytes32(uint256(keccak256("opstack.gaspayingtoken")) - 1)</code></td><td>Storage slot that contains the address and decimals of the gas paying token</td></tr>
<tr><td><code>GAS_PAYING_TOKEN_NAME_SLOT</code></td><td><code>bytes32(uint256(keccak256("opstack.gaspayingtokenname")) - 1)</code></td><td>Storage slot that contains the ERC20 <code>name()</code> of the gas paying token</td></tr>
<tr><td><code>GAS_PAYING_TOKEN_SYMBOL_SLOT</code></td><td><code>bytes32(uint256(keccak256("opstack.gaspayingtokensymbol")) - 1)</code></td><td>Storage slot that contains the ERC20 <code>symbol()</code> of the gas paying token</td></tr>
</tbody></table>
</div>
<h2 id="properties-of-a-gas-paying-token"><a class="header" href="#properties-of-a-gas-paying-token">Properties of a Gas Paying Token</a></h2>
<p>The gas paying token MUST satisfy the standard <a href="https://eips.ethereum.org/EIPS/eip-20">ERC20</a> interface
and implementation. It MUST be an L1 contract.</p>
<p>The gas paying token MUST NOT:</p>
<ul>
<li>Have a fee on transfer</li>
<li>Have rebasing logic</li>
<li>Have call hooks on transfer</li>
<li>Have other than 18 decimals</li>
<li>Have out of band methods for modifying balance or allowance</li>
<li>Have a <code>name()</code> that is more than 32 bytes long</li>
<li>Have a <code>symbol()</code> this is more than 32 bytes long</li>
</ul>
<p>It MUST be enforced on chain that the token has exactly 18 decimals to guarantee no losses of precision when
depositing a token that has a different number of decimals. It MUST be enforced on chain that the
token's <code>name</code> and <code>symbol</code> are less than 32 bytes to guarantee they can each fit into a single storage
slot.</p>
<p>It MAY be possible to support ERC20 tokens with varying amounts of decimals in the future.</p>
<h3 id="automated-validation"><a class="header" href="#automated-validation">Automated Validation</a></h3>
<p>Ideally it is possible to have automated validation of custom gas paying tokens to know that the token satisfies the
above properties. Due to the nature of the EVM, it may not always be possible to do so. <a href="https://eips.ethereum.org/EIPS/eip-165">ERC-165</a>
isn't always used by ERC20 tokens and isn't guaranteed to tell the truth. <a href="https://forum.openzeppelin.com/t/usdt-locked-in-a-contract-that-has-a-withdraw-token-function/32154/2">USDT</a>
does not correctly implement the ERC20 spec. It may be possible to use execution traces to observe the
properties of the ERC20 tokens but some degree of social consensus will be required for determining
the validity of an ERC20 token.</p>
<h2 id="configuring-the-gas-paying-token"><a class="header" href="#configuring-the-gas-paying-token">Configuring the Gas Paying Token</a></h2>
<p>The gas paying token is set within the L1 <code>SystemConfig</code> smart contract. This allows for easy access to the
information required to know if an OP Stack chain is configured to use a custom gas paying token. The gas paying
token is set during initialization and cannot be modified by the <code>SystemConfig</code> bytecode. Since the <code>SystemConfig</code>
is proxied, it is always possible to modify the storage slot that holds the gas paying token address directly
during an upgrade. It is assumed that the chain operator will not modify the gas paying token address unless they
specifically decide to do so and appropriately handle the consequences of the action.</p>
<p>The gas paying token address is network specific configuration, therefore it MUST be set in storage and not
as an immutable. This ensures that the same contract bytecode can be used by multiple OP Stack chains.</p>
<p>If the address in the <code>GAS_PAYING_TOKEN_SLOT</code> slot for <code>SystemConfig</code> is <code>address(0)</code>, the system is configured to
use <code>ether</code> as the gas paying token, and the getter for the token returns <code>ETHER_TOKEN_ADDRESS</code>. If the address in
the <code>GAS_PAYING_TOKEN_SLOT</code> slot for <code>SystemConfig</code> is not <code>address(0)</code>, the system is configured to use a custom
gas paying token, and the getter returns the address in the slot.</p>
<pre class="mermaid">flowchart LR
    subgraph Layer One
        OP[OptimismPortal]
        subgraph SystemConfig
          TA1[Token Address]
        end
        CO[Chain Operator] --&gt;|&quot;initialize()&quot;| SystemConfig
        SystemConfig --&gt;|&quot;setGasPayingToken()&quot;| OP
    end

    subgraph Layer Two
        subgraph L1Block
          TA2[Token Address]
        end
    end
    OP --&gt;|&quot;setGasPayingToken()&quot;| L1Block
</pre>
<h2 id="contract-modifications"><a class="header" href="#contract-modifications">Contract Modifications</a></h2>
<h3 id="igastoken-interface"><a class="header" href="#igastoken-interface">IGasToken Interface</a></h3>
<p>This interface encapsulates the shared interface.</p>
<pre><code class="language-solidity">interface IGasToken {
    /// @notice Getter for the ERC20 token address that is used to pay for gas and its decimals.
    function gasPayingToken() external view returns (address, uint8);
    /// @notice Returns the gas token name.
    function gasPayingTokenName() external view returns (string memory);
    /// @notice Returns the gas token symbol.
    function gasPayingTokenSymbol() external view returns (string memory);
    /// @notice Returns true if the network uses a custom gas token.
    function isCustomGasToken() external view returns (bool);
}
</code></pre>
<p>If a custom gas token is not used, then <code>gasPayingToken()</code> should return <code>(ETHER_TOKEN_ADDRESS, 18)</code>,
<code>gasPayingTokenName</code> should return <code>Ether</code> and <code>gasPayingTokenSymbol</code> should return <code>ETH</code>.</p>
<p>This interface applies to the following contracts:</p>
<ul>
<li><code>L1Block</code></li>
<li><code>SystemConfig</code></li>
</ul>
<h3 id="gas-token-aware"><a class="header" href="#gas-token-aware">Gas Token Aware</a></h3>
<p>The following contracts are aware internally if the chain is using a custom gas token
but do not expose anything as part of their ABI that indicates awareness.</p>
<ul>
<li><code>L1StandardBridge</code></li>
<li><code>L2StandardBridge</code></li>
<li><code>L1CrossDomainMessenger</code></li>
<li><code>L2CrossDomainMessenger</code></li>
<li><code>OptimismPortal</code></li>
</ul>
<h3 id="optimismportal"><a class="header" href="#optimismportal">OptimismPortal</a></h3>
<p>The <code>OptimismPortal</code> is updated with a new interface specifically for depositing custom tokens.</p>
<h4 id="depositerc20transaction"><a class="header" href="#depositerc20transaction"><code>depositERC20Transaction</code></a></h4>
<p>The <code>depositERC20Transaction</code> function is useful for sending custom gas tokens to L2. It is broken out into its
own interface to maintain backwards compatibility with chains that use <code>ether</code>, to help simplify the implementation
and make it explicit for callers that are trying to deposit an ERC20 native asset.</p>
<pre><code class="language-solidity">function depositERC20Transaction(
    address _to,
    uint256 _mint,
    uint256 _value,
    uint64 _gasLimit,
    bool _isCreation,
    bytes memory _data
) public;
</code></pre>
<p>This function MUST revert when <code>ether</code> is the L2's native asset. It MUST not be <code>payable</code>, meaning that it will
revert when <code>ether</code> is sent with a <code>CALL</code> to it. It uses a <code>transferFrom</code> flow, so users MUST first <code>approve()</code>
the <code>OptimismPortal</code> before they can deposit tokens.</p>
<h5 id="function-arguments"><a class="header" href="#function-arguments">Function Arguments</a></h5>
<p>The following table describes the arguments to <code>depositERC20Transaction</code></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>_to</code></td><td><code>address</code></td><td>The target of the deposit transaction</td></tr>
<tr><td><code>_mint</code></td><td><code>uint256</code></td><td>The amount of token to deposit</td></tr>
<tr><td><code>_value</code></td><td><code>uint256</code></td><td>The value of the deposit transaction, used to transfer native asset that is already on L2 from L1</td></tr>
<tr><td><code>_gasLimit</code></td><td><code>uint64</code></td><td>The gas limit of the deposit transaction</td></tr>
<tr><td><code>_isCreation</code></td><td><code>bool</code></td><td>Signifies the <code>_data</code> should be used with <code>CREATE</code></td></tr>
<tr><td><code>_data</code></td><td><code>bytes</code></td><td>The calldata of the deposit transaction</td></tr>
</tbody></table>
</div>
<h4 id="deposittransaction"><a class="header" href="#deposittransaction"><code>depositTransaction</code></a></h4>
<p>This function is the hot code path for all usage of the <code>L1StandardBridge</code> and <code>L1CrossDomainMessenger</code>, so it MUST
be as backwards compatible as possible. It MUST revert for chains using custom gas token when <code>ether</code> is sent with
the <code>CALL</code>. This prevents <code>ether</code> from being stuck in the <code>OptimismPortal</code>, since it cannot be used to mint native
asset on L2.</p>
<h4 id="setgaspayingtoken"><a class="header" href="#setgaspayingtoken"><code>setGasPayingToken</code></a></h4>
<p>This function MUST only be callable by the <code>SystemConfig</code>. When called, it creates a special deposit transaction
from the <code>DEPOSITOR_ACCOUNT</code> that calls the <code>L1Block.setGasPayingToken</code> function. The ERC20 <code>name</code> and <code>symbol</code>
are passed as <code>bytes32</code> to prevent the usage of dynamically sized <code>string</code> arguments.</p>
<pre><code class="language-solidity">function setGasPayingToken(address _token, uint8 _decimals, bytes32 _name, bytes32 _symbol) external;
</code></pre>
<h3 id="standardbridge"><a class="header" href="#standardbridge">StandardBridge</a></h3>
<p>The <code>StandardBridge</code> contracts on both L1 and L2 MUST be aware of the custom gas token. The <code>ether</code> specific ABI on the
<code>StandardBridge</code> is disabled when custom gas token is enabled.</p>
<p>The following methods MUST revert when custom gas token is being used:</p>
<ul>
<li><code>bridgeETH(uint32,bytes)</code></li>
<li><code>bridgeETHTo(address,uint32,bytes)</code></li>
<li><code>receive()</code></li>
<li><code>finalizeBridgeETH(address, address, uint256, bytes)</code></li>
</ul>
<p>The following legacy methods in <code>L1StandardBridge</code> MUST revert when custom gas token is being used:</p>
<ul>
<li><code>depositETH(uint32,bytes)</code></li>
<li><code>depositETHTo(address,uint32,bytes)</code></li>
<li><code>finalizeETHWithdrawal(address,address,uint256,bytes)</code></li>
</ul>
<p>The following legacy methods in <code>L2StandardBridge</code> MUST also revert when custom gas token is being used and the
CALLVALUE is nonzero:</p>
<ul>
<li><code>withdraw(address,uint256,uint32,bytes)</code></li>
<li><code>withdrawTo(address,address,uint256,uint32,bytes)</code></li>
<li><code>finalizeDeposit(address,address,address,address,uint256,bytes)</code></li>
</ul>
<h3 id="crossdomainmessenger"><a class="header" href="#crossdomainmessenger">CrossDomainMessenger</a></h3>
<p>The <code>CrossDomainMessenger</code> contracts on both L1 and L2 MUST NOT be able to faciliate the transfer of native asset
on custom gas token chains due to their tight coupling with <code>ether</code> and the <code>OptimismPortal</code> and <code>L2ToL1MessagePasser</code>
contracts.</p>
<p>It is possible to support this in the future with a redesign of the <code>CrossDomainMessenger</code> contract.
It would need to have conditional logic based on being a custom gas token chain and faciliate transfer
of the ERC20 token to the end user on the other side. It adds a layer of extra state modifying calls
so it may not be worth adding.</p>
<p>The following methods MUST revert when <code>CALLVALUE</code> is non zero:</p>
<ul>
<li><code>sendMessage(address,bytes,uint32)</code></li>
</ul>
<p>It should be impossible to call <code>relayMessage</code> when <code>CALLVALUE</code> is non zero, as it is enforced by <code>sendMessage</code>.</p>
<p>The <code>CrossDomainMessenger</code> also has the API for <em>getting</em> the custom gas token, namely <code>gasPayingToken()</code>, which outputs
a tuple of the address and decimals of the custom gas token.</p>
<ul>
<li>The <code>L1CrossDomainMessenger</code> fetches this tuple from the <code>SystemConfig</code> contract.</li>
<li>The <code>L2CrossDomainMessenger</code> fetches this tuple from the <code>L1Block</code> contract.</li>
</ul>
<h3 id="systemconfig"><a class="header" href="#systemconfig">SystemConfig</a></h3>
<p>The <code>SystemConfig</code> is the source of truth for the address of the custom gas token. It does on chain validation,
stores information about the token and well as passes the information to L2.</p>
<h4 id="initialize"><a class="header" href="#initialize">initialize</a></h4>
<p>The <code>SystemConfig</code> is modified to allow the address of the custom gas paying token to be set during the call
to <code>initialize</code>. Using a custom gas token is indicated by passing an address other than <code>ETHER_TOKEN_ADDRESS</code>
or <code>address(0)</code>. If <code>address(0)</code> is used for initialization, it MUST be mapped into <code>ETHER_TOKEN_ADDRESS</code>
before being forwarded to the rest of the system. When a custom gas token is set, the number of decimals
on the token MUST be exactly 18, the name of the token MUST be less than or equal to 32 bytes and the
symbol MUST be less than or equal to 32 bytes. If the token passes all of these checks,
<code>OptimismPortal.setGasPayingToken</code> is called. The implementation of <code>initialize</code> MUST not allow the chain
operator to change the address of the custom gas token if it is already set.</p>
<h3 id="l1block"><a class="header" href="#l1block">L1Block</a></h3>
<p>The <code>L1Block</code> contract is upgraded with a permissioned function <code>setGasPayingToken</code> that is used to set
information about the gas paying token. The <code>DEPOSITOR_ACCOUNT</code> MUST be the only account that can call the
setter function. This setter is differentiated from the <code>setL1BlockValues</code> functions because the gas paying
token is not meant to be dynamic config whereas the arguments to <code>setL1BlockValues</code> are generally dynamic in nature.</p>
<p>Any L2 contract that wants to learn the address of the gas paying token can call the getter on the
<code>L1Block</code> contract.</p>
<pre><code class="language-solidity">function setGasPayingToken(address _token, uint8 _decimals, byte32 _name, bytes32 _symbol) external;
</code></pre>
<h3 id="weth9"><a class="header" href="#weth9">WETH9</a></h3>
<p>The <code>WETH9</code> predeploy is updated so that it calls out to the <code>L1Block</code> contract to retreive the <code>name</code> and <code>symbol</code>.
This allows for front ends to more easily trust the token contract. It should prepend <code>Wrapped</code> to the <code>name</code>
and <code>W</code> to the <code>symbol</code>.</p>
<h2 id="user-flow"><a class="header" href="#user-flow">User Flow</a></h2>
<p>The user flow for custom gas token chains is slightly different than for chains that use <code>ether</code>
to pay for gas. The following tables highlight the methods that can be used for depositing and
withdrawing the native asset. Not every interface is included.</p>
<p>The <code>StandardBridge</code> and <code>CrossDomainMessenger</code> are symmetric in their APIs between L1 and L2
meaning that "sending to the other domain" indicates it can be used for both deposits and withdrawals.</p>
<h3 id="when-eth-is-the-native-asset"><a class="header" href="#when-eth-is-the-native-asset">When ETH is the Native Asset</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Method</th><th>Prerequisites</th></tr></thead><tbody>
<tr><td>Native Asset Send to Other Domain</td><td><code>L1StandardBridge.bridgeETH(uint32,bytes) payable</code></td><td>None</td></tr>
<tr><td>Native Asset and/or Message Send to Other Domain</td><td><code>L1CrossDomainMessenger.sendMessage(address,bytes,uint32) payable</code></td><td>None</td></tr>
<tr><td>Native Asset Deposit</td><td><code>OptimismPortal.depositTransaction(address,uint256,uint64,bool,bytes) payable</code></td><td>None</td></tr>
<tr><td>ERC20 Send to Other Domain</td><td><code>L1StandardBridge.bridgeERC20(address,address,uint256,uint32,bytes)</code></td><td>Approve <code>L1StandardBridge</code> for ERC20</td></tr>
<tr><td>Native Asset Withdrawal</td><td><code>L2ToL1MessagePasser.initiateWithdrawal(address,uint256,bytes) payable</code></td><td>None</td></tr>
</tbody></table>
</div>
<p>There are multiple APIs for users to deposit or withdraw <code>ether</code>. Depending on the usecase, different APIs should be
preferred. For a simple send of just <code>ether</code> with no calldata, the <code>OptimismPortal</code> or <code>L2ToL1MessagePasser</code> should
be used directly. If sending with calldata and replayability on failed calls is desired, the <code>CrossDomainMessenger</code>
should be used. Using the <code>StandardBridge</code> is the most expensive and has no real benefit for end users.</p>
<h3 id="when-an-erc20-token-is-the-native-asset"><a class="header" href="#when-an-erc20-token-is-the-native-asset">When an ERC20 Token is the Native Asset</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Scenario</th><th>Method</th><th>Prerequisites</th></tr></thead><tbody>
<tr><td>Native Asset Deposit</td><td><code>OptimismPortal.depositERC20Transaction(address,uint256,uint256,uint64,bool,bytes)</code></td><td>Approve <code>OptimismPortal</code> for ERC20</td></tr>
<tr><td>ERC20 Send to Other Domain</td><td><code>L1StandardBridge.bridgeERC20(address,address,uint256,uint32,bytes)</code></td><td>Approve <code>L1StandardBridge</code> for ERC20</td></tr>
<tr><td>Native Asset Withdrawal</td><td><code>L2ToL1MessagePasser.initiateWithdrawal(address,uint256,bytes) payable</code></td><td>None</td></tr>
</tbody></table>
</div>
<p>Users should deposit native asset by calling <code>depositERC20Transaction</code> on the <code>OptimismPortal</code> contract.
Users must first <code>approve</code> the address of the <code>OptimismPortal</code> so that the <code>OptimismPortal</code> can use
<code>transferFrom</code> to take ownership of the ERC20 asset.</p>
<p>Users should withdraw value by calling the <code>L2ToL1MessagePasser</code> directly.</p>
<p>The following diagram shows the control flow for when a user attempts to send <code>ether</code> through
the <code>StandardBridge</code>, either on L1 or L2.</p>
<pre class="mermaid">flowchart TD
    A1(User) --&gt;|Attempts to deposit/withdraw ether| A2(StandardBridge or CrossDomainMessenger)
    A2 --&gt;|Is chain using custom gas token?| A3{SystemConfig or L1Block}
    A3 --&gt; |Yes| A2
    A2 --&gt; |Revert| A1

</pre>
<h3 id="differences"><a class="header" href="#differences">Differences</a></h3>
<p>The main difference is that the <code>StandardBridge</code> and <code>CrossDomainMessenger</code> cannot be used to send the native asset
to the other domain when an ERC20 token is the native asset. The <code>StandardBridge</code> can still be used for bridging
arbitrary ERC20 tokens and the <code>CrossDomainMessenger</code> can still be used for arbitrary message passing.</p>
<h2 id="upgrade"><a class="header" href="#upgrade">Upgrade</a></h2>
<p>The custom gas token upgrade is not yet defined to be part of a particular network upgrade, but it will be scheduled
as part of a future hardfork. On the network upgrade block, a set of deposit transaction based upgrade transactions
are deterministically generated by the derivation pipeline in the following order:</p>
<ul>
<li>L1 Attributes Transaction calling <code>setL1BlockValuesEcotone</code></li>
<li>User deposits from L1</li>
<li>Network Upgrade Transactions
<ul>
<li>L1Block deployment</li>
<li>L2CrossDomainMessenger deployment</li>
<li>L2StandardBridge deployment</li>
<li>Update L1Block Proxy ERC-1967 Implementation Slot</li>
<li>Update L2CrossDomainMessenger Proxy ERC-1967 Implementation Slot</li>
<li>Update L2StandardBridge Proxy ERC-1967 Implementation Slot</li>
</ul>
</li>
</ul>
<p>The deployment transactions MUST have a <code>from</code> value that has no code and has no known
private key. This is to guarantee it cannot be frontran and have its nonce modified.
If this was possible, then an attacker would be able to modify the address that the
implementation is deployed to because it is based on <code>CREATE</code> and not <code>CREATE2</code>.
This would then cause the proxy implementation set transactions to set an incorrect
implementation address, resulting in a bricked contract. The calldata is not generated
dynamically to enable deterministic upgrade transactions across all networks.</p>
<p>The proxy upgrade transactions are from <code>address(0)</code> because the <code>Proxy</code> implementation
considers <code>address(0)</code> to be an admin. Going straight to the <code>Proxy</code> guarantees that
the upgrade will work because there is no guarantee that the <code>Proxy</code> is owned by the
<code>ProxyAdmin</code> and going through the <code>ProxyAdmin</code> would require stealing the identity
of its owner, which may be different on every chain. That would require adding L2
RPC access to the derivation pipeline and make the upgrade transactions non deterministic.</p>
<h3 id="l1block-deployment"><a class="header" href="#l1block-deployment">L1Block Deployment</a></h3>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000002</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: TODO</li>
<li><code>data</code>: TODO</li>
<li><code>sourceHash</code>: TODO</li>
</ul>
<h3 id="l2crossdomainmessenger-deployment"><a class="header" href="#l2crossdomainmessenger-deployment">L2CrossDomainMessenger Deployment</a></h3>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000003</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>375,000</code></li>
<li><code>data</code>: TODO</li>
<li><code>sourceHash</code>: TODO</li>
</ul>
<h3 id="l2standardbridge-deployment"><a class="header" href="#l2standardbridge-deployment">L2StandardBridge Deployment</a></h3>
<ul>
<li><code>from</code>: <code>0x4210000000000000000000000000000000000004</code></li>
<li><code>to</code>: <code>null</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>375,000</code></li>
<li><code>data</code>: TODO</li>
<li><code>sourceHash</code>: TODO</li>
</ul>
<h3 id="l1block-proxy-update"><a class="header" href="#l1block-proxy-update">L1Block Proxy Update</a></h3>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000015</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: TODO</li>
<li><code>sourceHash</code>: TODO</li>
</ul>
<h3 id="l2crossdomainmessenger-proxy-update"><a class="header" href="#l2crossdomainmessenger-proxy-update">L2CrossDomainMessenger Proxy Update</a></h3>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000007</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: TODO</li>
<li><code>sourceHash</code>: TODO</li>
</ul>
<h3 id="l2standardbridge-proxy-update"><a class="header" href="#l2standardbridge-proxy-update">L2StandardBridge Proxy Update</a></h3>
<ul>
<li><code>from</code>: <code>0x0000000000000000000000000000000000000000</code></li>
<li><code>to</code>: <code>0x4200000000000000000000000000000000000010</code></li>
<li><code>mint</code>: <code>0</code></li>
<li><code>value</code>: <code>0</code></li>
<li><code>gasLimit</code>: <code>50,000</code></li>
<li><code>data</code>: TODO</li>
<li><code>sourceHash</code>: TODO</li>
</ul>
<h2 id="selection-of-ether_token_address"><a class="header" href="#selection-of-ether_token_address">Selection of <code>ETHER_TOKEN_ADDRESS</code></a></h2>
<p>It was decided to use <code>address(0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE)</code> to represent <code>ether</code> to push
ecosystem standardization efforts around using this address to represent <code>ether</code> in <a href="https://eips.ethereum.org/EIPS/eip-7528">DeFi protocols</a>
or <a href="https://github.com/ethereum/execution-apis/pull/484">APIs</a>.</p>
<h2 id="standard-config"><a class="header" href="#standard-config">Standard Config</a></h2>
<p>There is currently no strong definition of what it means to be part of the standard config when using
the OP Stack with custom gas token enabled. This will be defined in the future.</p>
<h2 id="fees"><a class="header" href="#fees">Fees</a></h2>
<p>The OP Stack natively charges fees in terms of ether due to the fee formula taking into account the basefee and
blobbasefee. When a custom gas token is used, fees are paid in the custom gas token but the conversion rate to ether
is not taken into account as part of the protocol. It is assumed that the fees will be configured by the chain
operator such that the revenue earned in custom gas token can be swapped into ether to pay for posting the data to L1.</p>
<h2 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h2>
<h3 id="optimismportal-token-allowance"><a class="header" href="#optimismportal-token-allowance">OptimismPortal Token Allowance</a></h3>
<p>The <code>OptimismPortal</code> makes calls on behalf of users. It is therefore unsafe to be able to call the address of
the custom gas token itself from the <code>OptimismPortal</code> because it would be a simple way to <code>approve</code> an attacker's
balance and steal the entire ERC20 token balance of the <code>OptimismPortal</code>.</p>
<h3 id="interoperability-support"><a class="header" href="#interoperability-support">Interoperability Support</a></h3>
<p>Interop is supported between chains even if they use different custom gas tokens. The token address and the number of
decimals are legible on chain. In the future we may add the ability to poke a chain such that it emits an event that
includes the custom gas token address and its number of decimals to easily be able to introspect on the native asset
of another chain.</p>
<h3 id="wrapped-ether"><a class="header" href="#wrapped-ether">Wrapped Ether</a></h3>
<p>The <code>WETH9</code> predeploy at <code>0x4200000000000000000000000000000000000006</code> represents wrapped native asset and
not wrapped <code>ether</code>. Portable and fungible <code>ether</code> across different domains is left for a future project.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../experimental/fault-proof/stage-one/bridge-integration.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../experimental/plasma.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../experimental/fault-proof/stage-one/bridge-integration.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../experimental/plasma.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../specs/static/solidity.min.js"></script>
        <script src="../specs/static/mermaid.min.js"></script>
        <script src="../specs/static/mermaid-init.js"></script>


    </div>
    </body>
</html>
